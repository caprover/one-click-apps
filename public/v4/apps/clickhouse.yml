captainVersion: 4
services:
    $$cap_appname:
        image: clickhouse/clickhouse-server:$$cap_clickhouse_version
        volumes:
            - $$cap_appname-data:/var/lib/clickhouse
        restart: always
        environment:
            CLICKHOUSE_DB: $$cap_clickhouse_db
            CLICKHOUSE_USER: $$cap_clickhouse_user
            CLICKHOUSE_PASSWORD: $$cap_clickhouse_password
            CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: $$cap_clickhouse_access_management
        caproverExtra:
            notExposeAsWebApp: 'true'

caproverOneClickApp:
    variables:
        - id: $$cap_clickhouse_version
          label: ClickHouse Version
          defaultValue: '24.11-alpine'
          description: Check out their Docker page for the valid tags https://hub.docker.com/r/clickhouse/clickhouse-server/tags
          validRegex: /^([^\s^\/])+$/

        - id: $$cap_clickhouse_db
          label: Default Database
          defaultValue: default
          description: Initial database to create (optional, leave as 'default' if unsure)
          validRegex: /.{1,}/

        - id: $$cap_clickhouse_user
          label: Username
          defaultValue: clickhouse
          description: Username for ClickHouse access (leave empty to use default user)
          validRegex: /.{0,}/

        - id: $$cap_clickhouse_password
          label: Password
          defaultValue: $$cap_gen_random_hex(16)
          description: Password for the user (auto-generated by default)
          validRegex: /.{1,}/

        - id: $$cap_clickhouse_access_management
          label: Enable SQL-driven Access Control
          defaultValue: '1'
          description: Set to 1 to enable SQL-driven access control and account management (recommended)
          validRegex: /^(0|1)$/

    instructions:
        start: >-
            ClickHouse is a fast open-source column-oriented database management system
            that allows generating analytical data reports in real-time using SQL queries.


            This template will deploy ClickHouse with persistent storage and optional
            authentication configuration.

        end: >-
            ClickHouse has been successfully deployed!


            **Connection Details:**

            - HTTP Interface: srv-captain--$$cap_appname:8123

            - Native Protocol: srv-captain--$$cap_appname:9000

            - Database: $$cap_clickhouse_db

            - User: $$cap_clickhouse_user

            - Password: [as configured]


            **Usage Examples:**


            Connect from another app using HTTP:

            ```
            http://$$cap_clickhouse_user:$$cap_clickhouse_password@srv-captain--$$cap_appname:8123/$$cap_clickhouse_db
            ```


            Connect using clickhouse-client:

            ```
            clickhouse-client --host srv-captain--$$cap_appname --user $$cap_clickhouse_user --password $$cap_clickhouse_password
            ```


            **Important Notes:**

            - ClickHouse is NOT exposed to the internet by default (internal use only)

            - Data is persisted in a Docker volume for durability

            - For production use, consider setting up custom config files and users.xml

            - Default ports: 8123 (HTTP), 9000 (Native), 9009 (Interserver)

    displayName: ClickHouse
    isOfficial: true
    description: Fast open-source column-oriented database management system for real-time analytics
    documentation: Official docs at https://clickhouse.com/docs and Docker Hub at https://hub.docker.com/r/clickhouse/clickhouse-server
