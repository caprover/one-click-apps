captainVersion: 4
services:
    $$cap_appname-editor:
        caproverExtra:
            containerHttpPort: 5678
            websocketSupport: 'true'
        image: n8nio/n8n:$$cap_N8N_VERSION
        restart: always
        environment:
            DB_TYPE: postgresdb
            DB_POSTGRESDB_HOST: srv-captain--$$cap_appname-postgres
            DB_POSTGRESDB_DATABASE: $$cap_POSTGRES_DB
            DB_POSTGRESDB_USER: $$cap_POSTGRES_USER
            DB_POSTGRESDB_PASSWORD: $$cap_POSTGRES_PASSWORD
            GENERIC_TIMEZONE: $$cap_N8N_TIMEZONE
            TZ: $$cap_N8N_TIMEZONE
            NODE_ENV: $$cap_N8N_ENVIRONMENT
            N8N_PROTOCOL: https
            N8N_HOST: $$cap_appname-editor.$$cap_root_domain
            N8N_DIAGNOSTICS_ENABLED: $$cap_N8N_DIAGNOSTICS_ENABLED
            N8N_EMAIL_MODE: smtp
            N8N_SMTP_HOST: $$cap_N8N_SMTP_HOST
            N8N_SMTP_PORT: $$cap_N8N_SMTP_PORT
            N8N_SMTP_USER: $$cap_N8N_SMTP_USER
            N8N_SMTP_PASS: $$cap_N8N_SMTP_PASS
            N8N_SMTP_SENDER: $$cap_N8N_SMTP_SENDER
            N8N_SMTP_SSL: $$cap_N8N_SMTP_SSL
            WEBHOOK_URL: https://$$cap_appname-webhooks.$$cap_root_domain
            N8N_EDITOR_BASE_URL: https://$$cap_appname-editor.$$cap_root_domain
            N8N_RUNNERS_ENABLED: true
            N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: true
            N8N_DEFAULT_LOCALE: $$cap_N8N_DEFAULT_LOCALE
            N8N_ENCRYPTION_KEY: $$cap_N8N_ENCRYPTION_KEY
            EXECUTIONS_MODE: queue
            QUEUE_BULL_REDIS_HOST: srv-captain--$$cap_appname-redis
            QUEUE_BULL_REDIS_PORT: 6379
            N8N_CONCURRENCY_PRODUCTION_LIMIT: $$cap_N8N_CONCURRENCY_PRODUCTION_LIMIT
            OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS: true
        volumes:
            - $$cap_appname-data:/home/node/.n8n
            - $$cap_appname-files:/files
        networks:
            - $$cap_appname-network
        depends_on:
            - $$cap_appname-postgres
            - $$cap_appname-redis

    $$cap_appname-workers:
        caproverExtra:
            notExposeAsWebApp: 'true'
        image: n8nio/n8n:$$cap_N8N_VERSION
        restart: always
        environment:
            DB_TYPE: postgresdb
            DB_POSTGRESDB_HOST: srv-captain--$$cap_appname-postgres
            DB_POSTGRESDB_DATABASE: $$cap_POSTGRES_DB
            DB_POSTGRESDB_USER: $$cap_POSTGRES_USER
            DB_POSTGRESDB_PASSWORD: $$cap_POSTGRES_PASSWORD
            GENERIC_TIMEZONE: $$cap_N8N_TIMEZONE
            TZ: $$cap_N8N_TIMEZONE
            NODE_ENV: $$cap_N8N_ENVIRONMENT
            N8N_PROTOCOL: https
            N8N_HOST: $$cap_appname-editor.$$cap_root_domain
            N8N_DIAGNOSTICS_ENABLED: $$cap_N8N_DIAGNOSTICS_ENABLED
            N8N_EMAIL_MODE: smtp
            N8N_SMTP_HOST: $$cap_N8N_SMTP_HOST
            N8N_SMTP_PORT: $$cap_N8N_SMTP_PORT
            N8N_SMTP_USER: $$cap_N8N_SMTP_USER
            N8N_SMTP_PASS: $$cap_N8N_SMTP_PASS
            N8N_SMTP_SENDER: $$cap_N8N_SMTP_SENDER
            N8N_SMTP_SSL: $$cap_N8N_SMTP_SSL
            WEBHOOK_URL: https://$$cap_appname-webhooks.$$cap_root_domain
            N8N_EDITOR_BASE_URL: https://$$cap_appname-editor.$$cap_root_domain
            N8N_RUNNERS_ENABLED: true
            N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: true
            N8N_DEFAULT_LOCALE: $$cap_N8N_DEFAULT_LOCALE
            N8N_ENCRYPTION_KEY: $$cap_N8N_ENCRYPTION_KEY
            EXECUTIONS_MODE: queue
            QUEUE_BULL_REDIS_HOST: srv-captain--$$cap_appname-redis
            QUEUE_BULL_REDIS_PORT: 6379
            N8N_CONCURRENCY_PRODUCTION_LIMIT: $$cap_N8N_CONCURRENCY_PRODUCTION_LIMIT
            OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS: true
        volumes:
            - $$cap_appname-data:/home/node/.n8n
            - $$cap_appname-files:/files
        networks:
            - $$cap_appname-network
        depends_on:
            - $$cap_appname-postgres
            - $$cap_appname-redis
        command: ['n8n', 'worker']

    $$cap_appname-webhooks:
        caproverExtra:
            containerHttpPort: 5678
            websocketSupport: 'true'
        image: n8nio/n8n:$$cap_N8N_VERSION
        restart: always
        environment:
            DB_TYPE: postgresdb
            DB_POSTGRESDB_HOST: srv-captain--$$cap_appname-postgres
            DB_POSTGRESDB_DATABASE: $$cap_POSTGRES_DB
            DB_POSTGRESDB_USER: $$cap_POSTGRES_USER
            DB_POSTGRESDB_PASSWORD: $$cap_POSTGRES_PASSWORD
            GENERIC_TIMEZONE: $$cap_N8N_TIMEZONE
            TZ: $$cap_N8N_TIMEZONE
            NODE_ENV: $$cap_N8N_ENVIRONMENT
            N8N_PROTOCOL: https
            N8N_HOST: $$cap_appname-editor.$$cap_root_domain
            N8N_DIAGNOSTICS_ENABLED: $$cap_N8N_DIAGNOSTICS_ENABLED
            N8N_EMAIL_MODE: smtp
            N8N_SMTP_HOST: $$cap_N8N_SMTP_HOST
            N8N_SMTP_PORT: $$cap_N8N_SMTP_PORT
            N8N_SMTP_USER: $$cap_N8N_SMTP_USER
            N8N_SMTP_PASS: $$cap_N8N_SMTP_PASS
            N8N_SMTP_SENDER: $$cap_N8N_SMTP_SENDER
            N8N_SMTP_SSL: $$cap_N8N_SMTP_SSL
            WEBHOOK_URL: https://$$cap_appname-webhooks.$$cap_root_domain
            N8N_EDITOR_BASE_URL: https://$$cap_appname-editor.$$cap_root_domain
            N8N_RUNNERS_ENABLED: true
            N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: true
            N8N_DEFAULT_LOCALE: $$cap_N8N_DEFAULT_LOCALE
            N8N_ENCRYPTION_KEY: $$cap_N8N_ENCRYPTION_KEY
            EXECUTIONS_MODE: queue
            QUEUE_BULL_REDIS_HOST: srv-captain--$$cap_appname-redis
            QUEUE_BULL_REDIS_PORT: 6379
            N8N_CONCURRENCY_PRODUCTION_LIMIT: $$cap_N8N_CONCURRENCY_PRODUCTION_LIMIT
            OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS: true
        volumes:
            - $$cap_appname-data:/home/node/.n8n
            - $$cap_appname-files:/files
        networks:
            - $$cap_appname-network
        depends_on:
            - $$cap_appname-postgres
            - $$cap_appname-redis
        command: ['n8n', 'webhook']

    $$cap_appname-postgres:
        caproverExtra:
            notExposeAsWebApp: 'true'
        image: pgvector/pgvector:$$cap_POSTGRES_VERSION
        restart: always
        environment:
            POSTGRES_DB: $$cap_POSTGRES_DB
            POSTGRES_USER: $$cap_POSTGRES_USER
            POSTGRES_PASSWORD: $$cap_POSTGRES_PASSWORD
            TZ: $$cap_N8N_TIMEZONE
        volumes:
            - $$cap_appname-postgres-data:/var/lib/postgresql/data
        networks:
            - $$cap_appname-network

    $$cap_appname-redis:
        caproverExtra:
            notExposeAsWebApp: 'true'
        image: redis:$$cap_REDIS_VERSION
        restart: always
        volumes:
            - $$cap_appname-redis-data:/data
        networks:
            - $$cap_appname-network

volumes:
    '$$cap_appname-postgres-data':
    '$$cap_appname-redis-data':
    '$$cap_appname-data':
    '$$cap_appname-files':

networks:
    '$$cap_appname-network':
        driver: overlay

caproverOneClickApp:
    displayName: n8n.io Queue Mode
    description: Node based workflow automation tool - Queue mode
    isOfficial: true
    instructions:
        start: |-
            n8n in queue mode is an advanced execution setting designed for scalability and distributed workflow processing. 
            Unlike the default single-process mode, where triggers and workflow runs share the same thread, queue mode splits the backend into separate components.
            This separation enables horizontal scaling, improved performance under load, and isolation between trigger handling and execution.
        end: |-
            Deployment is complete!
            - Editor: http://$$cap_appname-editor.$$cap_root_domain
            - Webhook: http://$$cap_appname-webhooks.$$cap_root_domain
    variables:
        - id: $$cap_N8N_VERSION
          label: Application | n8n.io
          description: Check out their Docker page for the valid tags https://hub.docker.com/r/n8nio/n8n/tags
          defaultValue: '1.106.3'
          validRegex: /.{1,}/
        - id: $$cap_N8N_TIMEZONE
          label: Application | Timezone
          description: >-
              Timezone used by the server.
              Please check out this page for valid time zones: https://en.wikipedia.org/wiki/List_of_tz_database_time_zones
          defaultValue: 'UTC'
          validRegex: /.{1,}/
        - id: $$cap_N8N_ENVIRONMENT
          label: Application | Environment
          description: Application environment.
          defaultValue: 'production'
          validRegex: /^(production|development)$/
        - id: $$cap_N8N_DIAGNOSTICS_ENABLED
          label: Application | Enable Telemetry
          description: Whether to send telemetry data to n8n.io.
          defaultValue: 'false'
          validRegex: /^(true|false)$/
        - id: $$cap_N8N_DEFAULT_LOCALE
          label: Application | Locale
          description: A locale identifier, compatible with the Accept-Language header. n8n doesn't support regional identifiers, such as de-AT.
          defaultValue: en
          validRegex: /^([^\s^\/])+$/
        - id: $$cap_N8N_ENCRYPTION_KEY
          label: Application | Security
          description: The encryption key to handle with credentials
          defaultValue: $$cap_gen_random_hex(40)
          validRegex: /.{1,}/
        - id: $$cap_N8N_CONCURRENCY_PRODUCTION_LIMIT
          label: Application | Executions
          description: Set a concurrency limit for production worker concurrency.
          defaultValue: 10
          validRegex: /.{1,}/
        - id: $$cap_N8N_SMTP_HOST
          label: Application | SMTP Host
          description: SMTP host used for sending mails.
        - id: $$cap_N8N_SMTP_PORT
          label: Application | SMTP Port
          description: SMTP port used for sending mails. Usually `465`.
        - id: $$cap_N8N_SMTP_USER
          label: Application | SMTP User
          description: SMTP user used for sending mails.
        - id: $$cap_N8N_SMTP_PASS
          label: Application | SMTP Password
          description: SMTP user password used for sending mails.
        - id: $$cap_N8N_SMTP_SENDER
          label: Application | SMTP Sender
          description: SMTP sender used for sending mails (e.g. `N8N <n8n@example.com>`).
        - id: $$cap_N8N_SMTP_SSL
          label: Application | SMTP SSL
          description: Whether to use SSL for sending mails through SMTP.
          defaultValue: 'true'
          validRegex: /^(true|false)$/
        - id: $$cap_POSTGRES_VERSION
          label: Postgres | Version
          description: Check out their Docker page for the valid tags https://hub.docker.com/r/pgvector/pgvector/tags
          defaultValue: 'pg14'
          validRegex: /.{1,}/
        - id: $$cap_POSTGRES_DB
          label: Postgres | Name
          defaultValue: n8n_queue
          description: Name of the PostgreSQL Postgres.
          validRegex: /.{1,}/
        - id: $$cap_POSTGRES_USER
          label: Postgres | User
          defaultValue: n8n_queue
          description: Username for the PostgreSQL Postgres.
          validRegex: /.{1,}/
        - id: $$cap_POSTGRES_PASSWORD
          label: Postgres | Password
          description: Password of the PostgreSQL Postgres user.
          defaultValue: $$cap_gen_random_hex(50)
          validRegex: /.{1,}/
        - id: $$cap_REDIS_VERSION
          label: Redis | Version
          description: 'Check out their Docker page for the valid tags: https://hub.docker.com/_/redis?tab=tags'
          defaultValue: 8.2.0
          validRegex: /^([^\s^\/])+$/
