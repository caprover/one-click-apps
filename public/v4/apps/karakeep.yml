captainVersion: 4
services:
    $$cap_appname:
        image: ghcr.io/karakeep-app/karakeep:$$cap_karakeep_version
        restart: unless-stopped
        volumes:
            - $$cap_appname-data:/data
        environment:
            NEXTAUTH_SECRET: $$cap_nextauth_secret
            MEILI_MASTER_KEY: $$cap_meili_master_key
            NEXTAUTH_URL: https://$$cap_appname.$$cap_root_domain
            MEILI_ADDR: http://srv-captain--$$cap_appname-meilisearch:7700
            BROWSER_WEB_URL: http://srv-captain--$$cap_appname-chrome:9222
            DATA_DIR: /data # Do not change this. Volume mapping is handled by CapRover.
            OPENAI_API_KEY: $$cap_openai_api_key
            OLLAMA_BASE_URL: $$cap_ollama_base_url
            INFERENCE_TEXT_MODEL: $$cap_inference_text_model
            INFERENCE_IMAGE_MODEL: $$cap_inference_image_model
            INFERENCE_CONTEXT_LENGTH: $$cap_inference_context_length
        depends_on:
            - $$cap_appname-chrome
            - $$cap_appname-meilisearch
        caproverExtra:
            containerHttpPort: '3000'

    $$cap_appname-chrome:
        image: gcr.io/zenika-hub/alpine-chrome:123 # Pinned version
        restart: unless-stopped
        command:
            - chromium-browser
            - --headless
            - --no-sandbox
            - --disable-gpu
            - --disable-dev-shm-usage
            - --remote-debugging-address=0.0.0.0
            - --remote-debugging-port=9222
            - --hide-scrollbars
        caproverExtra:
            notExposeAsWebApp: 'true'

    $$cap_appname-meilisearch:
        image: getmeili/meilisearch:v1.13.3 # Pinned version
        restart: unless-stopped
        environment:
            MEILI_MASTER_KEY: $$cap_meili_master_key
            MEILI_NO_ANALYTICS: 'true'
        volumes:
            - $$cap_appname-meilisearch-data:/meili_data
        caproverExtra:
            notExposeAsWebApp: 'true'

caproverOneClickApp:
    variables:
        - id: '$$cap_karakeep_version'
          label: Karakeep Version
          defaultValue: '0.24.1'
          description: 'The tag for the Karakeep image. Use "release" for latest stable, or accept the default version which was most recent when this definition file was created. Check tags here: https://github.com/karakeep-app/karakeep/pkgs/container/karakeep'
          validRegex: '/^([a-zA-Z0-9.-]+)$/'
        - id: '$$cap_nextauth_secret'
          label: NextAuth Secret
          defaultValue: '$$cap_gen_random_hex(36)'
          description: 'A random secret string for securing sessions. A random one is generated by default.'
          validRegex: '/.{32,}/'
        - id: '$$cap_meili_master_key'
          label: Meilisearch Master Key
          defaultValue: '$$cap_gen_random_hex(36)'
          description: 'A master key for Meilisearch access. A random one is generated by default.'
          validRegex: '/.{16,}/'
        - id: '$$cap_openai_api_key'
          label: OpenAI API Key (Optional)
          description: 'Enter your OpenAI API key to enable automatic tagging. Leave empty to disable.'
          defaultValue: ''
        - id: '$$cap_ollama_base_url'
          label: Ollama Base URL (Optional)
          description: 'URL of your Ollama instance (e.g., http://ollama:11434) for local inference. Leave empty if not using Ollama.'
          defaultValue: ''
        - id: '$$cap_inference_text_model'
          label: Ollama Text Model (Optional)
          description: 'The Ollama model to use for text inference (e.g., llama3.1). Requires Ollama Base URL.'
          defaultValue: 'llama3.1'
        - id: '$$cap_inference_image_model'
          label: Ollama Image Model (Optional)
          description: 'The Ollama model to use for image inference (e.g., llava). Requires Ollama Base URL.'
          defaultValue: 'llava'
        - id: '$$cap_inference_context_length'
          label: Ollama Context Length (Optional)
          description: 'Context length for Ollama models. Larger values may improve tag quality but increase resource usage. Requires Ollama Base URL.'
          defaultValue: '2048'

    instructions:
        start: |-
            Karakeep is a self-hosted bookmark manager with archiving, tagging (including AI auto-tagging), and search capabilities.
            It requires three services: the main web app, a headless Chrome instance for archival/screenshots, and Meilisearch for search.
            Enter your desired configuration below.
            - Set the Karakeep version (default is latest stable 'release').
            - Secure secrets are generated by default.
            - Optionally, provide an OpenAI API key for AI tagging, or configure Ollama for local inference.
        end: |-
            Karakeep is deploying!
            Web App: https://$$cap_appname.$$cap_root_domain
            It might take a minute or two for all services to start.
            You can manage persistence for Karakeep data ('$$cap_appname-data') and Meilisearch data ('$$cap_appname-meilisearch-data') in the volumes tab of your CapRover dashboard.
            Remember to install the browser extensions and mobile apps for easier saving: https://docs.karakeep.app/quick-sharing-extensions
    displayName: 'Karakeep'
    isOfficial: false # Uses official MeiliSearch and Karakeep containers, but the Chrome dependency is not maintained by Google.
    description: 'Self-hosted bookmark manager with archiving, AI tagging (OpenAI/Ollama), screenshots, and full-text search.'
    documentation: 'Based on the official Karakeep Docker Compose setup: https://docs.karakeep.app/Installation/docker'
volumes:
    - $$cap_appname-data
    - $$cap_appname-meilisearch-data
