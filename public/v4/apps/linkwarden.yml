captainVersion: 4
caproverOneClickApp:
    displayName: Linkwarden
    isOfficial: true
    description: Self-hosted collaborative bookmark manager to collect, read, annotate, and fully preserve what matters, all in one place.
    documentation: This docker-compose is taken from https://github.com/linkwarden/linkwarden/blob/main/docker-compose.yml
    instructions:
        start: Just a plain Docker Compose.
        end: Docker Compose is deployed.
    variables:
        - id: '$$cap_nextauth_secret'
          label: NextAuth Secret
          defaultValue: '$$cap_gen_random_hex(36)'
          description: 'A random secret string for securing sessions. A random one is generated by default.'
          validRegex: '/.{32,}/'
        - id: '$$cap_meili_master_key'
          label: Meilisearch Master Key
          defaultValue: '$$cap_gen_random_hex(36)'
          description: 'A master key for Meilisearch access. A random one is generated by default.'
          validRegex: '/.{16,}/'
        - id: $$cap_pg_user
          label: Username
          defaultValue: postgres
          validRegex: /.{1,}/
        - id: $$cap_pg_pass
          label: Password
          defaultValue: $$cap_gen_random_hex(16)
          validRegex: /.{1,}/
        - id: $$cap_pg_db
          label: Default Database
          defaultValue: postgres
          validRegex: /.{1,}/
########
version: '2.13.1'

services:
    $$cap_appname-postgres:
        image: postgres:16-alpine
        restart: always
        volumes:
            - $$cap_appname-pg-data:/var/lib/postgresql/data
        environment:
            POSTGRES_USER: $$cap_pg_user
            POSTGRES_PASSWORD: $$cap_pg_pass
            POSTGRES_DB: $$cap_pg_db
        caproverExtra:
            notExposeAsWebApp: 'true'

    $$cap_appname-meilisearch:
        image: getmeili/meilisearch:v1.12.8
        restart: always
        volumes:
            - $$cap_appname-meili-data:/meili_data
        environment:
            MEILI_MASTER_KEY: $$cap_meili_master_key
        caproverExtra:
            notExposeAsWebApp: 'true'

    $$cap_appname:
        image: ghcr.io/linkwarden/linkwarden:v2.13.1
        restart: always
        depends_on:
            - $$cap_appname-postgres
            - $$cap_appname-meilisearch
        caproverExtra:
            containerHttpPort: '3000'
        volumes:
            - $$cap_appname-data:/data/data
        environment:
            NEXTAUTH_URL: http://$$cap_appname.$$cap_root_domain
            NEXTAUTH_SECRET: $$cap_nextauth_secret
            DATABASE_URL: postgresql://$$cap_pg_user:$$cap_pg_pass@srv-captain--$$cap_appname-postgres:5432/$$cap_pg_db
            MEILISEARCH_URL: http://srv-captain--$$cap_appname-meilisearch:7700
            MEILISEARCH_MASTER_KEY: $$cap_meili_master_key
